#

## IM交互规则

CrossContact是一款有去中心化的CS架构通讯服务的即时通讯软件，同时他又提供了一个默认的公用通讯服务器（以下简称公服），那意味着需要一个合适的交互逻辑将各个子消息服务和CrossContact做合适的连接。  
这个文档将介绍私有服务器是如何接入到CrossContact并提供自己的消息服务的。

### 1. 私有服务器的接入

  私有通讯服务器（以下简称私服）需要能够被公网访问，能够和中心服务器通讯。私服需要在CrossContact进行注册，CrossContact预留私服的访问信息。  
  在CrossContact中，每张名片都会有一个通讯服务的信息，这就这张名片收发消息所使用的服务器。默认的通讯服务器就是公服。用户可以将自己的某张名片通讯服务绑定到某个私服，之后该名片的聊天消息收发都会通过那个私服进行。而私服可以自定义自己的转发、缓存、发送策略。
  私服接入CrossContact后需要配置如下信息：

  > - 不可修改的服务名称，和法律要求的提供通讯服务的资料
  > - 连接地址、域名或公网IP
  > - 转发条件，是否允许非本私服消息数据的通讯（即聊天的两端是否必须是使用这个私服进行消息收发）

  私服需要有一个长连接和CrossContact一直保持连接。以告知CrossContact当前是否可以进行通讯。

### 2. 基本授权流程

首先，私服的绑定是以名片为单位。  
名片向CrossContact申请生成授权token，拿到token后发送给私服。私服拿到授权token后，向CrossContact服务端请求授权服务，CrossContact服务端收到这个token后，在CrossContact客户端进行是否允许授权的询问交互。如果用户同意授权后，该名片的通讯服务器就会被设定为该私服。  
如果私服和公服的长连接断开，或处于无法通讯的状态，消息会通过公服发送。

### 3. 通讯的逻辑

> - 发送方接收方都为公服，发送接收直接通过公服进行。
> - 发送方公服，接收方私服，消息先发送到公服，公服检查私服是否允许公服转发。  
> 如果不允许，这返回发送失败。  
> 如果允许则发送给私服，私服返回发送状态，最后由公服将发送成功/失败的结果返回请求端。可以看到在这种情况下，发送状态完全有私服决定。
> - 发送方为私服，接收方为公服。消息先发送到私服，私服更具是否可以和公服通讯的配置判断是否要转发。  
> 如果私服不允许转发，直接返回失败状态给请求端。  
> 允许转发则私服将信息发送到公服，公服发送到对应的客户端并返回状态。
> - 发送和接收方为同一个私服。双方直接与私服交互，不经过公服，消息规则完全由私服自定。
> - 发送方与接收方为不同私服。发送的策略由对应的私服自定，所有消息都会通过公服转发到对应私服。转发到私服的规则即私服的发送规则。
> - 私服不在线，则通过公服进行通讯。

  **由以上的规则可以看到，公服与私服是一种平行、平等的关系**